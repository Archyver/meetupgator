<!doctype html>
<html>
 <head>
  <title>MeetupGator</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
  <link rel='stylesheet' type='text/css' href='/css/fullcalendar.css' />
  <style>
.btn.btn-table {
  padding: 1px 5px 1px;
  font-size: 7px;
  margin-right: -3px;
  margin-top: -3px;
 }
  </style>
 </head>
 <body>
  <a href="https://github.com/pamelafox/meetupgator"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

 <div class="container" style="margin-top:20px;">
     <div class="well pull-right" style="width: 40%;">
      <p>To add a group, enter its meetup URL or URL name: <br>
      <div class="form-inline">
      <input type="text" id="group-id"> <button id="add-group" class="btn btn-small" type="button">Add</button>
      </div>
      </p>

      <table class="table" id="groups-table" style="display:none;">
       <thead>
        <tr><th>Group  <th>Upcoming Events <th>
       </thead>
       <tbody></tbody>
      </table>
    </div>

  <div>
   <strong style="font-size:24px;">MeetupGator</strong> <br><br>
   <p>See upcoming events from multiple meetup groups, all on one page. Bookmark for easy access.
For example, check out the <a href="/#groups=sf-html5,jsmeetup,beerjs,BayNode">SF JS meetups</a>, the <a href="/#groups=Women-Who-Code-SF,Girl-Develop-It-San-Francisco,PyLadiesSF">SF Women in Tech meetups</a>
or the <a href="/#groups=girldevelopit,Girl-Develop-It-Cincinnati,girldevelopitcbus,Girl-Develop-It-Austin,Girl-Develop-It-Philadelphia,Girl-Develop-It-Ottawa,girldevelopit-sydney">GirlDevelopIt chapters</a>.
   </p>
  </div>

     


    <div id="events-calendar"></div>

    <table class="table" id="events-table" style="display:none;">
     <thead>
      <tr><th>Date/Time   <th>Event   <th>Group
     </thead>
     <tbody></tbody>
    </table>

 </div>

 <script src="/js/moment.min.js"></script>
 <script src="/js/jquery.min.js"></script>
 <script src='/js/fullcalendar.min.js'></script>
<script type="text/javascript">
var MG = {};
MG.groups = [];
MG.groupedEvents = {};


function getHashParam(name) {
  var regexS = name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var splitUrl = unescape(window.location.href).split('#');
  var hash  = ((splitUrl.length > 1) && splitUrl[1]) || '';
  var results = regex.exec(hash);
  if( results === null )
    return null;
  else
    return results[1];
}

function changeHashParam(name, value) {
  var regexS = name  + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var hash  = window.location.hash;
  var results = regex.exec(hash);
  if (getHashParam(name)) {
    window.location.hash = window.location.hash.replace(regex, name + '=' + value);
  } else {
    if (window.location.hash.indexOf('=') > -1) {
      window.location.hash += '&';
    }
    window.location.hash += name + '=' + value;
  }
}

function getGroupsFromHash() {
  var groupsHash = getHashParam('groups');
  if (groupsHash) return groupsHash.split(',');
  return [];
}

function addGroupToHash(groupId) {
  var groups = getGroupsFromHash();
  groups.push(groupId);
  changeHashParam('groups', groups.join(','));
}

function removeGroupFromHash(groupId) {
  var groups = getGroupsFromHash();
  var idx = groups.indexOf(groupId);
  if (idx != -1) {
    groups.splice(idx, 1);
    changeHashParam('groups', groups.join(','));
  }
}


function renderEvents() {
  $('#events-table tbody').empty();

  var allEvents = [];
  $.each(MG.groupedEvents, function(groupId, events) {
    allEvents = allEvents.concat(MG.groupedEvents[groupId]);
  });

  // Sort events by time
  allEvents.sort(function(a, b) {
    return a.time > b.time;
  });

  // Add to table
  $.each(allEvents, function(index, event) {
    
    var dateTime = moment(event.time).format('dddd, MMMM Do YYYY, h:mm:ss a');
    var eventStr = '<a href="' + event.event_url + '">' + event.name + '</a>';
    var groupId  = event.group.urlname;
    var groupStr = '<a href="http://meetup.com/' + groupId + '">' + groupId + '</a>';
    // add to calendar
    var $eventRow = $('<tr><td>' + dateTime + '<td>' + eventStr + '<td>' + groupStr);
    $eventRow.addClass('group-' + groupId);
    $('#events-table tbody').append($eventRow);
  });

  // Only show table if there are enough events
  if (allEvents.length > 0) {
    $('#events-table').show();
  }

  $('#events-calendar').fullCalendar('refetchEvents')
}

function renderGroups() {
  $('#groups-table tbody').empty();

  var allGroups = [];
  $.each(MG.groupedEvents, function(groupId, events) {
    allGroups.push(groupId);
  });

  // Sort alphabetically
  allGroups.sort();

  $.each(allGroups, function(index, groupId) {
    var groupStr = '<a href="http://meetup.com/' + groupId + '">' + groupId + '</a>';
    var $groupRow = $('<tr>').addClass('group-' + groupId);
    $groupRow.append('<td>' + groupStr);
    var badgeClass = (MG.groupedEvents[groupId].length > 0) ? 'badge badge-success' : 'badge';
    $groupRow.append('<td><span class="' + badgeClass + '">' + MG.groupedEvents[groupId].length + '</span>');
    var $removeButton = $('<td><button class="btn btn-table remove-group">X</button>');
    $removeButton.on('click', function() {
      delete MG.groupedEvents[groupId];
      removeGroupFromHash(groupId);
      renderGroups();
      renderEvents();
    });
    $groupRow.append($removeButton);
    $('#groups-table tbody').append($groupRow);
  });

  if (allGroups.length > 0) {
    $('#groups-table').show();
  }
}

function getGroupEvents(groupId) {
  var meetupParams = {'key': '551f79233a251a351215671b7a60',
                      'group_urlname': groupId};
  var meetupUrl = 'https://api.meetup.com/2/events.json?' + $.param(meetupParams);

  var proxyUrl = '/proxy?url=' + escape(meetupUrl);
  $.getJSON(proxyUrl, function(data){
    if(data){
      MG.groupedEvents[groupId] = data.results;
      renderGroups();
      renderEvents();
    }
  });
}

function refreshGroups() {
  // For anything in hash we dont have events for, fetch them
  var groups = getGroupsFromHash();
  $.each(groups, function(index, groupId) {
    if (!(groupId in MG.groupedEvents)) {
      getGroupEvents(groupId);
    }
  });

  // If there are groups in our data that arent in hash, delete
  $.each(MG.groupedEvents, function(groupId, events) {
    if ($.inArray(groupId, groups) == -1) {
      delete MG.groupedEvents[groupId];
    }
  });
}

$(document).ready(function(){

  $('#add-group').on('click', function(event) {
    event.preventDefault();
    var groupId = $('#group-id').val();
    if (groupId.indexOf('meetup.com') > -1) {
      var regEx = /meetup.com\/([^/]*)/g;
      groupId = regEx.exec(groupId)[1];
    }
    if (!MG.groupedEvents[groupId]) {
      addGroupToHash(groupId);
      getGroupEvents(groupId);
    }
  });

  $('#events-calendar').fullCalendar({
    editable: false,
    aspectRatio: 2,
    header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,basicWeek,basicDay'
    },
    events: function(start, end, callback) {
      var allEvents = [];
      $.each(MG.groupedEvents, function(groupId, events) {
        $.each(events, function(index, event) {
          allEvents.push({title: event.name, start: new Date(event.time), url: event.event_url});
        });
      });
      callback(allEvents);
    }
  });

  $(window).on('hashchange', function() {
    refreshGroups();
  });
  refreshGroups();
});

</script>
</body>
</html>